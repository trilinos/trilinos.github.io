<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tempus: 02_Use_ModelEvaluator.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Tempus<span id="projectnumber">&#160;Version of the Day</span>
   </div>
   <div id="projectbrief">Time Integration</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d28a4824dc47e487b107a5db32ef43c4.html">examples</a></li><li class="navelem"><a class="el" href="dir_15a5d8b65eb89d7db3f7bd333148dc24.html">02_Use_ModelEvaluator</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">02_Use_ModelEvaluator.cpp File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;iomanip&gt;</code><br />
<code>#include &lt;iostream&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;math.h&gt;</code><br />
<code>#include &quot;Teuchos_StandardCatchMacros.hpp&quot;</code><br />
<code>#include &quot;Thyra_VectorStdOps.hpp&quot;</code><br />
<code>#include &quot;Thyra_DefaultSpmdVectorSpace.hpp&quot;</code><br />
<code>#include &quot;Thyra_DetachedVectorView.hpp&quot;</code><br />
<code>#include &quot;<a class="el" href="VanDerPol__ModelEvaluator__02_8hpp_source.html">VanDerPol_ModelEvaluator_02.hpp</a>&quot;</code><br />
</div>
<p><a href="02__Use__ModelEvaluator_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a0ddf1224851353fc92bfbff6f499fa97" id="r_a0ddf1224851353fc92bfbff6f499fa97"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="02__Use__ModelEvaluator_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a> (int argc, char *argv[])</td></tr>
<tr class="memdesc:a0ddf1224851353fc92bfbff6f499fa97"><td class="mdescLeft">&#160;</td><td class="mdescRight">Description:  <br /></td></tr>
<tr class="separator:a0ddf1224851353fc92bfbff6f499fa97"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a0ddf1224851353fc92bfbff6f499fa97" name="a0ddf1224851353fc92bfbff6f499fa97"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0ddf1224851353fc92bfbff6f499fa97">&#9670;&#160;</a></span>main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>argv</em>[]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Description: </p>
<h1><a class="anchor" id="example-02"></a>
Example 2: Use ModelEvaluator</h1>
<p>The next step in our progression is to use a <a class="elRef" href="/home/runner/work/trilinos.github.io/trilinos.github.io/Trilinos/packages/tempus/doc/../../../packages/nox/doc/html/classThyra_1_1ModelEvaluator.html">Thyra::ModelEvaluator</a> for the application problem, i.e., <a class="el" href="00__Basic__Problem_8cpp.html#vanderpol">van der Pol Problem</a>, and will provide a common interface to Abstract Numerical Algorithms (ANAs), e.g., nonlinear equations, <a class="elRef" href="/home/runner/work/trilinos.github.io/trilinos.github.io/Trilinos/packages/tempus/doc/../../../packages/nox/doc/html/namespaceNOX.html">NOX</a>; stability analysis, <a class="elRef" href="/home/runner/work/trilinos.github.io/trilinos.github.io/Trilinos/packages/tempus/doc/../../../packages/nox/doc/html/namespaceLOCA_1_1Abstract.html">LOCA</a>; transient nonlinear ODEs, <a class="el" href="namespaceTempus.html">Tempus</a>; and sensitivity analysis, Sacado. For this example, we will be focusing on setting up a ModelEvaluator for transient nonlinear equations (e.g., explicit and implicit ODEs), and therefore this is not meant to be an indepth tutorial on ModelEvaluators. Please refer to <a href="https://docs.trilinos.org/dev/packages/thyra/doc/html/classThyra_1_1ModelEvaluator.html">https://docs.trilinos.org/dev/packages/thyra/doc/html/classThyra_1_1ModelEvaluator.html</a> and <a href="https://bartlettroscoe.github.io/publications/ModelEvaluator_HPCSW2008.pdf">https://bartlettroscoe.github.io/publications/ModelEvaluator_HPCSW2008.pdf</a>. for additional details on ModelEvaluators.</p>
<h2><a class="anchor" id="MEbasics"></a>
ModelEvaluator Basics</h2>
<p>Because the ModelEvaluator is a generic interface to all the ANAs, the primary function to evaluate the various quantities is simply </p><div class="fragment"><div class="line"><a class="code hl_classRef" href="/home/runner/work/trilinos.github.io/trilinos.github.io/Trilinos/packages/tempus/doc/../../../packages/nox/doc/html/classThyra_1_1ModelEvaluator.html">Thyra::ModelEvaluator&lt; Scalar &gt;::evalModel</a>(</div>
<div class="line">  <span class="keyword">const</span> ModelEvaluatorBase::InArgs&lt; Scalar &gt; &amp; inArgs,</div>
<div class="line">  <span class="keyword">const</span> ModelEvaluatorBase::OutArgs&lt; Scalar &gt; &amp; outArgs ) <span class="keyword">const</span></div>
<div class="ttc" id="aclassThyra_1_1ModelEvaluator_html"><div class="ttname"><a href="/home/runner/work/trilinos.github.io/trilinos.github.io/Trilinos/packages/tempus/doc/../../../packages/nox/doc/html/classThyra_1_1ModelEvaluator.html">Thyra::ModelEvaluator</a></div></div>
</div><!-- fragment --><p> where InArgs contains all the required information for the ModelEvaluator to compute the request from the ANA (i.e., <a class="el" href="namespaceTempus.html">Tempus</a>), and OutArgs will contain the computed quantities. In <a class="el" href="namespaceTempus.html">Tempus</a>'s case of explicit first-order ODEs ( <picture><source srcset="form_452_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$ \dot{x} = f(x,t)$" src="form_452.png" width="59" height="14"/></picture>), the InArgs is just <picture><source srcset="form_1_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$x$" src="form_1.png" width="8" height="6"/></picture> and <picture><source srcset="form_458_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$t$" src="form_458.png" width="5" height="9"/></picture> and the OutArgs is <picture><source srcset="form_2_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\dot{x}$" src="form_2.png" width="8" height="9"/></picture>. For implicit first-order ODEs ( <picture><source srcset="form_349_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$ f(\dot{x},x,t) $" src="form_349.png" width="46" height="14"/></picture>), the InArgs is <picture><source srcset="form_454_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$ \dot{x} $" src="form_454.png" width="8" height="9"/></picture>, <picture><source srcset="form_1_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$x$" src="form_1.png" width="8" height="6"/></picture> and <picture><source srcset="form_458_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$t$" src="form_458.png" width="5" height="9"/></picture> and the OutArgs is the function evaluation, <picture><source srcset="form_349_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$ f(\dot{x},x,t) $" src="form_349.png" width="46" height="14"/></picture>. Thus through the InArgs and OutArgs, the ModelEvaluator can determine which evaluation is being requested.</p>
<p>One important attribute of ModelEvaluators is they are <b>stateless</b>! This means they do not storage any information that might change over the duration of the simulation, i.e., the ModelEvaluator does <b>not</b> contain any state information. Any state information must be passed in through the inputs (i.e., InArgs). A simple test for this attribute is the ModelEvaluator will return the exact same evaluation (i.e., OutArgs) for two consecutive evaluations, i.e., </p><div class="fragment"><div class="line">evalModel(inArgs, outArgs1);</div>
<div class="line">evalModel(inArgs, outArgs2);</div>
</div><!-- fragment --><p> and outArgs1 = outArgs2! The stateless attribute is very important for <a class="el" href="namespaceTempus.html">Tempus</a>, because timesteps may fail and need to be retried with a new timestep size. If the ModelEvaluator is not stateless, then the re-evaluation will change! The solvers (e.g., <a class="elRef" href="/home/runner/work/trilinos.github.io/trilinos.github.io/Trilinos/packages/tempus/doc/../../../packages/nox/doc/html/namespaceNOX.html">NOX</a>) have a similar issue with multiple evaluations, and also require the stateless attribute.</p>
<p>For details on the ModelEvaluator for the <a class="el" href="00__Basic__Problem_8cpp.html#vanderpol">van der Pol Problem</a> implemented in this example, please review <a class="el" href="classVanDerPol__ModelEvaluator__02.html" title="ModelEvaluator implementation for the example van der Pol Problem.">VanDerPol_ModelEvaluator_02</a>.</p>
<h2><a class="anchor" id="changesToUseME"></a>
Changes to Use ModelEvaluator</h2>
<p>In the following table are code snippets of the changes from the <a class="el" href="01__Utilize__Thyra_8cpp.html">01_Utilize_Thyra.cpp</a> to <a class="el" href="02__Use__ModelEvaluator_8cpp.html">02_Use_ModelEvaluator.cpp</a>. This is similar taking a difference between them for the <a class="el" href="02__Use__ModelEvaluator_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97" title="Description:">main()</a> function.</p>
<table class="doxtable">
<tr>
<th>Comments </th><th>"Utilize Thyra" Code Snippet </th><th>"Use ModelEvaluator" Code Snippet </th></tr>
<tr valign="top">
<td><b>Construct the ModelEvaluator.</b> The ModelEvaluator, <a class="el" href="classVanDerPol__ModelEvaluator__02.html" title="ModelEvaluator implementation for the example van der Pol Problem.">VanDerPol_ModelEvaluator_02</a>, now has all information to construct the problem, including the problem size, vectorLength, parameters, and initial conditions. </td><td><div class="fragment"><div class="line"><span class="comment">// Solution and its time-derivative.</span></div>
<div class="line"><span class="keywordtype">int</span> vectorLength = 2;  <span class="comment">// number state unknowns</span></div>
<div class="line">RCP&lt;const Thyra::VectorSpaceBase&lt;double&gt; &gt;  xSpace =</div>
<div class="line">  Thyra::defaultSpmdVectorSpace&lt;double&gt;(vectorLength);</div>
</div><!-- fragment --> </td><td><div class="fragment"><div class="line"><span class="comment">// Construct ModelEvaluator</span></div>
<div class="line">Teuchos::RCP&lt;const Thyra::ModelEvaluator&lt;double&gt; &gt;</div>
<div class="line">  model = Teuchos::rcp(<span class="keyword">new</span> <a class="code hl_class" href="classVanDerPol__ModelEvaluator__02.html">VanDerPol_ModelEvaluator_02&lt;double&gt;</a>());</div>
<div class="ttc" id="aclassVanDerPol__ModelEvaluator__02_html"><div class="ttname"><a href="classVanDerPol__ModelEvaluator__02.html">VanDerPol_ModelEvaluator_02</a></div><div class="ttdoc">ModelEvaluator implementation for the example van der Pol Problem.</div><div class="ttdef"><b>Definition</b> <a href="VanDerPol__ModelEvaluator__02_8hpp_source.html#l00026">VanDerPol_ModelEvaluator_02.hpp:28</a></div></div>
</div><!-- fragment --> </td></tr>
<tr valign="top">
<td><b>Get ICs from the ModelEvaluator.</b> The initial conditions (i.e., nominal values) have moved to the <a class="el" href="classVanDerPol__ModelEvaluator__02.html" title="ModelEvaluator implementation for the example van der Pol Problem.">VanDerPol_ModelEvaluator_02</a> constructor, and can retrieved via getNominalValues(). </td><td><div class="fragment"><div class="line">RCP&lt;Thyra::VectorBase&lt;double&gt; &gt; x_n    = Thyra::createMember(xSpace);</div>
<div class="line">RCP&lt;Thyra::VectorBase&lt;double&gt; &gt; xDot_n = Thyra::createMember(xSpace);</div>
<div class="line"><span class="comment">// Initial Conditions</span></div>
<div class="line"><span class="keywordtype">double</span> time = 0.0;</div>
<div class="line"><span class="keywordtype">double</span> epsilon = 1.0e-1;</div>
<div class="line">{ <span class="comment">// Scope to delete DetachedVectorViews</span></div>
<div class="line">  Thyra::DetachedVectorView&lt;double&gt; x_n_view(*x_n);</div>
<div class="line">  x_n_view[0] = 2.0;</div>
<div class="line">  x_n_view[1] = 0.0;</div>
<div class="line">  Thyra::DetachedVectorView&lt;double&gt; xDot_n_view(*xDot_n);</div>
<div class="line">  xDot_n_view[0] = 0.0;</div>
<div class="line">  xDot_n_view[1] = -2.0/epsilon;</div>
<div class="line">}</div>
</div><!-- fragment --> </td><td><div class="fragment"><div class="line"><span class="comment">// Get initial conditions from ModelEvaluator::getNominalValues.</span></div>
<div class="line">RCP&lt;Thyra::VectorBase&lt;double&gt; &gt; x_n    =</div>
<div class="line">  model-&gt;getNominalValues().get_x()-&gt;clone_v();</div>
<div class="line">RCP&lt;Thyra::VectorBase&lt;double&gt; &gt; xDot_n =</div>
<div class="line">  model-&gt;getNominalValues().get_x_dot()-&gt;clone_v();</div>
</div><!-- fragment --> </td></tr>
<tr valign="top">
<td><b>Setup InArgs and OutArgs for the ModelEvaluator.</b> Before calling evalModel(InArgs, OutArgs), the InArgs and OutArgs need to be setup. For an explicit ODE, we need to set the time, the solution vector, x, and the time derivative, x_dot. In InArgs, x_dot needs to be set to null to indicate it is an explicit ODE evaluation. Finally, we set the outArgs f evaluation to the time derivative, xDot, so it is filled with the result. </td><td><div class="fragment"></div><!-- fragment --> </td><td><div class="fragment"><div class="line"><span class="comment">// For explicit ODE formulation, xDot = f(x, t),</span></div>
<div class="line"><span class="comment">// xDot is part of the outArgs.</span></div>
<div class="line"><span class="keyword">auto</span> inArgs  = model-&gt;createInArgs();</div>
<div class="line"><span class="keyword">auto</span> outArgs = model-&gt;createOutArgs();</div>
<div class="line">inArgs.set_t(time);</div>
<div class="line">inArgs.set_x(x_n);</div>
<div class="line">inArgs.set_x_dot(Teuchos::null);</div>
<div class="line">outArgs.set_f(xDot_n);</div>
</div><!-- fragment --> </td></tr>
<tr valign="top">
<td><b>Evaluate the ModelEvaluator.</b> The righthand-side evaluation is now in the ModelEvaluator, and is called with evalModel(InArgs, OutArgs). Note that xDot has been filled in and can be accessed for the Forward-Euler update. </td><td><div class="fragment"><div class="line"><span class="comment">// Righthand side evaluation and time-derivative at n.</span></div>
<div class="line">{</div>
<div class="line">  Thyra::ConstDetachedVectorView&lt;double&gt; x_n_view(*x_n);</div>
<div class="line">  Thyra::DetachedVectorView&lt;double&gt; xDot_n_view(*xDot_n);</div>
<div class="line">  xDot_n_view[0] = x_n_view[1];</div>
<div class="line">  xDot_n_view[1] =</div>
<div class="line">    ((1.0-x_n_view[0]*x_n_view[0])*x_n_view[1]-x_n_view[0])/epsilon;</div>
<div class="line">}</div>
</div><!-- fragment --> </td><td><div class="fragment"><div class="line"><span class="comment">// Righthand side evaluation and time-derivative at n.</span></div>
<div class="line">model-&gt;evalModel(inArgs, outArgs);</div>
</div><!-- fragment --> </td></tr>
</table>
<p>The remainder of <a class="el" href="02__Use__ModelEvaluator_8cpp.html">02_Use_ModelEvaluator.cpp</a> is regression testing, etc.</p>
<h2><a class="anchor" id="example-02_Next"></a>
Links</h2>
<ul>
<li>Back to: <a class="el" href="index.html#tutorials">Tutorials</a></li>
<li>Previous: <a class="el" href="01__Utilize__Thyra_8cpp.html#example-01">Example 1: Utilize Thyra</a></li>
<li>Next: <a class="el" href="03__Intro__SolutionState_8cpp.html#example-03">Example 3: Introduce SolutionState</a> </li>
</ul>

<p class="definition">Definition at line <a class="el" href="02__Use__ModelEvaluator_8cpp_source.html#l00203">203</a> of file <a class="el" href="02__Use__ModelEvaluator_8cpp_source.html">02_Use_ModelEvaluator.cpp</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
