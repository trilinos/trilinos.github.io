<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpetraExt: EpetraExt_petsc.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">EpetraExt<span id="projectnumber">&#160;Development</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">EpetraExt_petsc.cpp</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><div class="line"><span class="comment">// @HEADER</span></div>
<div class="line"><span class="comment">// *****************************************************************************</span></div>
<div class="line"><span class="comment">//           Trilinos: An Object-Oriented Solver Framework</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Copyright 2001-2024 NTESS and the Trilinos contributors.</span></div>
<div class="line"><span class="comment">// SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment">// *****************************************************************************</span></div>
<div class="line"><span class="comment">// @HEADER</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;ml_config.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;EpetraExt_config.h&quot;</span></div>
<div class="line"><span class="preprocessor">#if defined(HAVE_PETSC) &amp;&amp; defined(HAVE_ML_EPETRA) &amp;&amp; defined(HAVE_ML_TEUCHOS) &amp;&amp; defined(HAVE_ML_AZTECOO) &amp;&amp; defined(HAVE_MPI)</span></div>
<div class="line"><span class="preprocessor">#include &quot;petscksp.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="EpetraExt__PETScAIJMatrix_8h.html">EpetraExt_PETScAIJMatrix.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_Vector.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_Map.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ml_MultiLevelPreconditioner.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;AztecOO.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_LinearProblem.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* </span></div>
<div class="line"><span class="comment">   This example demonstrates how to apply a Trilinos preconditioner to a PETSc</span></div>
<div class="line"><span class="comment">   linear system.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">   For information on configuring and building Trilinos with the PETSc aij</span></div>
<div class="line"><span class="comment">   interface enabled, please see EpetraExt&#39;s doxygen documentation at</span></div>
<div class="line"><span class="comment">   http://trilinos.sandia.gov/packages/epetraext, development version</span></div>
<div class="line"><span class="comment">   or release 9.0 or later.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">   The PETSc matrix is a 2D 5-point Laplace operator stored in AIJ format.</span></div>
<div class="line"><span class="comment">   This matrix is wrapped as an Epetra_PETScAIJMatrix, and an ML AMG</span></div>
<div class="line"><span class="comment">   preconditioner is created for it.  The associated linear system is solved twice,</span></div>
<div class="line"><span class="comment">   the first time using AztecOO&#39;s preconditioned CG, the second time using PETSc&#39;s.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">   To invoke this example, use something like:</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">       mpirun -np 5 ./TrilinosCouplings_petsc.exe -m 150 -n 150 -petsc_smoother -ksp_monitor_true_residual</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> help[] = <span class="stringliteral">&quot;Demonstrates how to solve a PETSc linear system with KSP\</span></div>
<div class="line"><span class="stringliteral">and a Trilinos AMG preconditioner.  In particular, it shows how to wrap a PETSc\</span></div>
<div class="line"><span class="stringliteral">AIJ matrix as an Epetra matrix, create the AMG preconditioner, and wrap it as a\</span></div>
<div class="line"><span class="stringliteral">shell preconditioner for a PETSc Krylov method.\</span></div>
<div class="line"><span class="stringliteral">Input parameters include:\n\</span></div>
<div class="line"><span class="stringliteral">  -random_exact_sol : use a random exact solution vector\n\</span></div>
<div class="line"><span class="stringliteral">  -view_exact_sol   : write exact solution vector to stdout\n\</span></div>
<div class="line"><span class="stringliteral">  -m &lt;mesh_x&gt;       : number of mesh points in x-direction\n\</span></div>
<div class="line"><span class="stringliteral">  -n &lt;mesh_n&gt;       : number of mesh points in y-direction\n\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (PETSC_VERSION_MAJOR &lt; 3) || (PETSC_VERSION_MAJOR == 3 &amp;&amp; PETSC_VERSION_MINOR &lt; 1)</span></div>
<div class="line"><span class="keyword">extern</span> PetscErrorCode ShellApplyML(<span class="keywordtype">void</span>*,Vec,Vec);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="keyword">extern</span> PetscErrorCode ShellApplyML(PC,Vec,Vec);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#undef __FUNCT__</span></div>
<div class="line"><span class="preprocessor">#define __FUNCT__ &quot;main&quot;</span></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc,<span class="keywordtype">char</span> **args)</div>
<div class="line">{</div>
<div class="line">  Vec            x,b,u;  <span class="comment">/* approx solution, RHS, exact solution */</span></div>
<div class="line">  Mat            A;        <span class="comment">/* linear system matrix */</span></div>
<div class="line">  KSP            ksp;     <span class="comment">/* linear solver context */</span></div>
<div class="line">  KSP            kspSmoother=0;  <span class="comment">/* solver context for PETSc fine grid smoother */</span></div>
<div class="line">  PC pc;</div>
<div class="line">  PetscRandom    rctx;     <span class="comment">/* random number generator context */</span></div>
<div class="line">  PetscReal      norm;     <span class="comment">/* norm of solution error */</span></div>
<div class="line">  PetscInt       i,j,Ii,J,Istart,Iend,its;</div>
<div class="line">  PetscInt       m = 50,n = 50; <span class="comment">/* #mesh points in x &amp; y directions, resp. */</span></div>
<div class="line">  PetscErrorCode ierr;</div>
<div class="line">  PetscBool     flg;</div>
<div class="line">  PetscScalar    v,one = 1.0,neg_one = -1.0;</div>
<div class="line">  PetscInt rank=0;</div>
<div class="line">  MPI_Comm comm;</div>
<div class="line"> </div>
<div class="line">  PetscInitialize(&amp;argc,&amp;args,(<span class="keywordtype">char</span> *)0,help);</div>
<div class="line">  ierr = PetscOptionsGetInt(PETSC_NULL,<span class="stringliteral">&quot;-m&quot;</span>,&amp;m,PETSC_NULL);CHKERRQ(ierr);</div>
<div class="line">  ierr = PetscOptionsGetInt(PETSC_NULL,<span class="stringliteral">&quot;-n&quot;</span>,&amp;n,PETSC_NULL);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  ierr = MatCreate(PETSC_COMM_WORLD,&amp;A);CHKERRQ(ierr);</div>
<div class="line">  ierr = MatSetSizes(A,PETSC_DECIDE,PETSC_DECIDE,m*n,m*n);CHKERRQ(ierr);</div>
<div class="line">  ierr = MatSetType(A, MATAIJ);CHKERRQ(ierr);</div>
<div class="line">  ierr = MatSetFromOptions(A);CHKERRQ(ierr);</div>
<div class="line">  ierr = MatMPIAIJSetPreallocation(A,5,PETSC_NULL,5,PETSC_NULL);CHKERRQ(ierr);</div>
<div class="line">  ierr = MatSetUp(A);CHKERRQ(ierr);</div>
<div class="line">  PetscObjectGetComm( (PetscObject)A, &amp;comm);</div>
<div class="line">  ierr = MPI_Comm_rank(comm,&amp;rank);CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">if</span> (!rank) printf(<span class="stringliteral">&quot;Matrix has %d (%dx%d) rows\n&quot;</span>,m*n,m,n);</div>
<div class="line"> </div>
<div class="line">  ierr = MatGetOwnershipRange(A,&amp;Istart,&amp;Iend);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (Ii=Istart; Ii&lt;Iend; Ii++) { </div>
<div class="line">    v = -1.0; i = Ii/n; j = Ii - i*n;  </div>
<div class="line">    <span class="keywordflow">if</span> (i&gt;0)   {J = Ii - n; ierr = MatSetValues(A,1,&amp;Ii,1,&amp;J,&amp;v,INSERT_VALUES);CHKERRQ(ierr);}</div>
<div class="line">    <span class="keywordflow">if</span> (i&lt;m-1) {J = Ii + n; ierr = MatSetValues(A,1,&amp;Ii,1,&amp;J,&amp;v,INSERT_VALUES);CHKERRQ(ierr);}</div>
<div class="line">    <span class="keywordflow">if</span> (j&gt;0)   {J = Ii - 1; ierr = MatSetValues(A,1,&amp;Ii,1,&amp;J,&amp;v,INSERT_VALUES);CHKERRQ(ierr);}</div>
<div class="line">    <span class="keywordflow">if</span> (j&lt;n-1) {J = Ii + 1; ierr = MatSetValues(A,1,&amp;Ii,1,&amp;J,&amp;v,INSERT_VALUES);CHKERRQ(ierr);}</div>
<div class="line">    v = 4.0; ierr = MatSetValues(A,1,&amp;Ii,1,&amp;Ii,&amp;v,INSERT_VALUES);CHKERRQ(ierr);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  ierr = MatAssemblyBegin(A,MAT_FINAL_ASSEMBLY);CHKERRQ(ierr);</div>
<div class="line">  ierr = MatAssemblyEnd(A,MAT_FINAL_ASSEMBLY);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Wrap the PETSc matrix as an Epetra_PETScAIJMatrix. This is lightweight,</span></div>
<div class="line"><span class="comment">     i.e., no deep data copies. */</span></div>
<div class="line">  <a class="code hl_class" href="classEpetra__PETScAIJMatrix.html">Epetra_PETScAIJMatrix</a> epA(A);</div>
<div class="line"> </div>
<div class="line">  ierr = VecCreate(PETSC_COMM_WORLD,&amp;u);CHKERRQ(ierr);</div>
<div class="line">  ierr = VecSetSizes(u,PETSC_DECIDE,m*n);CHKERRQ(ierr);</div>
<div class="line">  ierr = VecSetFromOptions(u);CHKERRQ(ierr);</div>
<div class="line">  ierr = VecDuplicate(u,&amp;b);CHKERRQ(ierr); </div>
<div class="line"> </div>
<div class="line">  ierr = VecDuplicate(b,&amp;x);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  ierr = PetscOptionsHasName(PETSC_NULL,<span class="stringliteral">&quot;-random_exact_sol&quot;</span>,&amp;flg);CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">if</span> (flg) {</div>
<div class="line">    ierr = PetscRandomCreate(PETSC_COMM_WORLD,&amp;rctx);CHKERRQ(ierr);</div>
<div class="line">    ierr = PetscRandomSetFromOptions(rctx);CHKERRQ(ierr);</div>
<div class="line">    ierr = VecSetRandom(u,rctx);CHKERRQ(ierr);</div>
<div class="line">    ierr = PetscRandomDestroy(&amp;rctx);CHKERRQ(ierr);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    ierr = VecSet(u,one);CHKERRQ(ierr);</div>
<div class="line">  }</div>
<div class="line">  ierr = MatMult(A,u,b);CHKERRQ(ierr);</div>
<div class="line">  ierr = VecNorm(b,NORM_2,&amp;norm);CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">if</span> (rank==0) printf(<span class="stringliteral">&quot;||b|| = %f\n&quot;</span>,norm);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Copy the PETSc vectors to Epetra vectors. */</span></div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__Vector.html">Epetra_Vector</a> epu(epA.Map()), epb(epA.Map());</div>
<div class="line">  PetscScalar *vals;</div>
<div class="line">  ierr = VecGetArray(u,&amp;vals);CHKERRQ(ierr);</div>
<div class="line">  PetscInt length;</div>
<div class="line">  ierr = VecGetLocalSize(u,&amp;length);CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;length; j++) epu[j] = vals[j];</div>
<div class="line">  ierr = VecRestoreArray(u,&amp;vals);CHKERRQ(ierr);</div>
<div class="line">  epA.Multiply(<span class="keyword">false</span>, epu, epb);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Check norms of the Epetra and PETSc vectors. */</span></div>
<div class="line">  epu.Norm2(&amp;norm);</div>
<div class="line">  <span class="keywordflow">if</span> (rank == 0) printf(<span class="stringliteral">&quot;||epetra u||_2 = %f\n&quot;</span>,norm);</div>
<div class="line">  ierr = VecNorm(u,NORM_2,&amp;norm);CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">if</span> (rank == 0) printf(<span class="stringliteral">&quot;||petsc u||_2  = %f\n&quot;</span>,norm);</div>
<div class="line">  epb.Norm2(&amp;norm);</div>
<div class="line">  <span class="keywordflow">if</span> (rank == 0) printf(<span class="stringliteral">&quot;||epetra b||_2 = %f\n&quot;</span>,norm);</div>
<div class="line">  ierr = VecNorm(b,NORM_2,&amp;norm);CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">if</span> (rank == 0) printf(<span class="stringliteral">&quot;||petsc b||_2  = %f\n&quot;</span>,norm);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Create the ML AMG preconditioner. */</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Parameter list that holds options for AMG preconditioner. */</span></div>
<div class="line">  Teuchos::ParameterList mlList;</div>
<div class="line">  <span class="comment">/* Set recommended defaults for Poisson-like problems. */</span></div>
<div class="line">  ML_Epetra::SetDefaults(<span class="stringliteral">&quot;SA&quot;</span>,mlList);</div>
<div class="line">  <span class="comment">/* Specify how much information ML prints to screen.</span></div>
<div class="line"><span class="comment">     0 is the minimum (no output), 10 is the maximum. */</span></div>
<div class="line">  mlList.set(<span class="stringliteral">&quot;ML output&quot;</span>,10);</div>
<div class="line">  <span class="comment">/* Set the fine grid smoother.  PETSc will be much faster for any</span></div>
<div class="line"><span class="comment">     smoother requiring row access, e.g., SOR.  For any smoother whose</span></div>
<div class="line"><span class="comment">     kernel is a matvec, Trilinos/PETSc performance should be comparable,</span></div>
<div class="line"><span class="comment">     as Trilinos simply calls the PETSc matvec.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">     To use a PETSc smoother, create a KSP object, set the KSP type to</span></div>
<div class="line"><span class="comment">     KSPRICHARDSON, and set the desired smoother as the KSP preconditioner.</span></div>
<div class="line"><span class="comment">     It is important that you call KSPSetInitialGuessNonzero.  Otherwise, the</span></div>
<div class="line"><span class="comment">     post-smoother phase will incorrectly ignore the current approximate</span></div>
<div class="line"><span class="comment">     solution.  The KSP pointer must be cast to void* and passed to ML via</span></div>
<div class="line"><span class="comment">     the parameter list.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">     You are responsible for freeing the KSP object.</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">  ierr = PetscOptionsHasName(PETSC_NULL,<span class="stringliteral">&quot;-petsc_smoother&quot;</span>,&amp;flg);CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">if</span> (flg) {</div>
<div class="line">    ierr = KSPCreate(comm,&amp;kspSmoother);CHKERRQ(ierr);</div>
<div class="line">    ierr = KSPSetOperators(kspSmoother,A,A);CHKERRQ(ierr);</div>
<div class="line">    ierr = KSPSetType(kspSmoother,KSPRICHARDSON);CHKERRQ(ierr);</div>
<div class="line">    ierr = KSPSetTolerances(kspSmoother, 1e-12, 1e-50, 1e7,1);</div>
<div class="line">    ierr = KSPSetInitialGuessNonzero(kspSmoother,PETSC_TRUE);CHKERRQ(ierr);</div>
<div class="line">    ierr = KSPGetPC(kspSmoother,&amp;pc);CHKERRQ(ierr);</div>
<div class="line">    ierr = PCSetType(pc, PCSOR);CHKERRQ(ierr);</div>
<div class="line">    ierr = PCSORSetSymmetric(pc,SOR_LOCAL_SYMMETRIC_SWEEP);CHKERRQ(ierr);</div>
<div class="line">    ierr = PCSetFromOptions(pc);CHKERRQ(ierr);</div>
<div class="line">    ierr = KSPSetUp(kspSmoother);CHKERRQ(ierr);</div>
<div class="line">    mlList.set(<span class="stringliteral">&quot;smoother: type (level 0)&quot;</span>,<span class="stringliteral">&quot;petsc&quot;</span>);</div>
<div class="line">    mlList.set(<span class="stringliteral">&quot;smoother: petsc ksp (level 0)&quot;</span>,(<span class="keywordtype">void</span>*)kspSmoother);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    mlList.set(<span class="stringliteral">&quot;smoother: type (level 0)&quot;</span>,<span class="stringliteral">&quot;symmetric Gauss-Seidel&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* how many fine grid pre- or post-smoothing sweeps to do */</span></div>
<div class="line">  mlList.set(<span class="stringliteral">&quot;smoother: sweeps (level 0)&quot;</span>,2);</div>
<div class="line"> </div>
<div class="line">  ML_Epetra::MultiLevelPreconditioner *Prec = <span class="keyword">new</span> ML_Epetra::MultiLevelPreconditioner(epA,mlList);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Trilinos CG */</span></div>
<div class="line">  epu.PutScalar(0.0);</div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__LinearProblem.html">Epetra_LinearProblem</a> Problem(&amp;epA, &amp;epu, &amp;epb);</div>
<div class="line">  AztecOO solver(Problem);</div>
<div class="line">  solver.SetAztecOption(AZ_solver, AZ_cg);</div>
<div class="line">  solver.SetAztecOption(AZ_output, 1);</div>
<div class="line">  solver.SetAztecOption(AZ_conv, AZ_noscaled);</div>
<div class="line">  solver.SetPrecOperator(Prec);</div>
<div class="line">  solver.Iterate(30, 1e-12);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* PETSc CG */</span></div>
<div class="line">  ierr = KSPCreate(PETSC_COMM_WORLD,&amp;ksp);CHKERRQ(ierr);</div>
<div class="line">  ierr = KSPSetOperators(ksp,A,A);CHKERRQ(ierr);</div>
<div class="line">  ierr = KSPSetTolerances(ksp,1e-12,1.e-50,PETSC_DEFAULT,</div>
<div class="line">                          PETSC_DEFAULT);CHKERRQ(ierr);</div>
<div class="line">  ierr = KSPSetType(ksp,KSPCG);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Wrap the ML preconditioner as a PETSc shell preconditioner. */</span></div>
<div class="line">  ierr = KSPGetPC(ksp,&amp;pc);CHKERRQ(ierr);</div>
<div class="line">  ierr = PCSetType(pc,PCSHELL);CHKERRQ(ierr);</div>
<div class="line">  ierr = PCShellSetApply(pc,ShellApplyML);CHKERRQ(ierr);</div>
<div class="line">  ierr = PCShellSetContext(pc,(<span class="keywordtype">void</span>*)Prec);CHKERRQ(ierr);</div>
<div class="line">  ierr = PCShellSetName(pc,<span class="stringliteral">&quot;ML AMG&quot;</span>);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  ierr = KSPSetFromOptions(ksp);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  ierr = KSPSolve(ksp,b,x);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  ierr = KSPView(ksp,PETSC_VIEWER_STDOUT_WORLD);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  ierr = VecAXPY(x,neg_one,u);CHKERRQ(ierr);</div>
<div class="line">  ierr = VecNorm(x,NORM_2,&amp;norm);CHKERRQ(ierr);</div>
<div class="line">  ierr = KSPGetIterationNumber(ksp,&amp;its);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  ierr = PetscPrintf(PETSC_COMM_WORLD,<span class="stringliteral">&quot;Norm of error %e iterations %D\n&quot;</span>,</div>
<div class="line">                     norm,its);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  ierr = KSPDestroy(&amp;ksp);CHKERRQ(ierr);</div>
<div class="line">  ierr = VecDestroy(&amp;u);CHKERRQ(ierr);  ierr = VecDestroy(&amp;x);CHKERRQ(ierr);</div>
<div class="line">  ierr = VecDestroy(&amp;b);CHKERRQ(ierr);  ierr = MatDestroy(&amp;A);CHKERRQ(ierr);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (kspSmoother) {ierr = KSPDestroy(&amp;kspSmoother);CHKERRQ(ierr);}</div>
<div class="line">  <span class="keywordflow">if</span> (Prec) <span class="keyword">delete</span> Prec;</div>
<div class="line"> </div>
<div class="line">  ierr = PetscFinalize();CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">} <span class="comment">/*main*/</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* ***************************************************************** */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (PETSC_VERSION_MAJOR &lt; 3) || (PETSC_VERSION_MAJOR == 3 &amp;&amp; PETSC_VERSION_MINOR &lt; 1)</span></div>
<div class="line">PetscErrorCode ShellApplyML(<span class="keywordtype">void</span> *ctx,Vec x,Vec y)</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">PetscErrorCode ShellApplyML(PC pc,Vec x,Vec y)</div>
<div class="line">{</div>
<div class="line">  PetscErrorCode  ierr;</div>
<div class="line">  ML_Epetra::MultiLevelPreconditioner *mlp = 0;</div>
<div class="line">  <span class="keywordtype">void</span>* ctx;</div>
<div class="line"> </div>
<div class="line">  ierr = PCShellGetContext(pc,&amp;ctx); CHKERRQ(ierr);  </div>
<div class="line">  mlp = (ML_Epetra::MultiLevelPreconditioner*)ctx;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Wrap x and y as Epetra_Vectors. */</span></div>
<div class="line">  <span class="comment">// NOTE: We should not be const casting xvals, but we do promise not to modify the entries.</span></div>
<div class="line">  <span class="keyword">const</span> PetscScalar *xvals;</div>
<div class="line">  PetscScalar *nonconst_xvals, *yvals;</div>
<div class="line">  ierr = VecGetArrayRead(x,&amp;xvals);CHKERRQ(ierr);</div>
<div class="line">  nonconst_xvals = <span class="keyword">const_cast&lt;</span>PetscScalar*<span class="keyword">&gt;</span>(xvals);</div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__Vector.html">Epetra_Vector</a> epx(View,mlp-&gt;OperatorDomainMap(),nonconst_xvals);</div>
<div class="line">  ierr = VecGetArray(y,&amp;yvals);CHKERRQ(ierr);</div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__Vector.html">Epetra_Vector</a> epy(View,mlp-&gt;OperatorRangeMap(),yvals);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Apply ML. */</span></div>
<div class="line">  mlp-&gt;ApplyInverse(epx,epy);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Clean up and return. */</span></div>
<div class="line">  ierr = VecRestoreArrayRead(x,&amp;xvals);CHKERRQ(ierr);</div>
<div class="line">  ierr = VecRestoreArray(y,&amp;yvals);CHKERRQ(ierr);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">} <span class="comment">/*ShellApplyML*/</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#ifdef HAVE_MPI</span></div>
<div class="line"><span class="preprocessor">#include &quot;mpi.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#ifdef HAVE_MPI</span></div>
<div class="line">  MPI_Init(&amp;argc,&amp;argv);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  printf(<span class="stringliteral">&quot;Please configure EpetraExt with:&quot;</span>);</div>
<div class="line"><span class="preprocessor">#if !defined(HAVE_PETSC)</span></div>
<div class="line">  printf(<span class="stringliteral">&quot;--enable-petsc&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if !defined(HAVE_ML_EPETRA)</span></div>
<div class="line">  printf(<span class="stringliteral">&quot;--enable-epetra&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if !defined(HAVE_ML_TEUCHOS)</span></div>
<div class="line">  printf(<span class="stringliteral">&quot;--enable-teuchos&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if !defined(HAVE_ML_AZTECOO)</span></div>
<div class="line">  printf(<span class="stringliteral">&quot;--enable-aztecoo&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef HAVE_MPI</span></div>
<div class="line">  MPI_Finalize();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span>(EXIT_SUCCESS);</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="ttc" id="aEpetraExt__PETScAIJMatrix_8h_html"><div class="ttname"><a href="EpetraExt__PETScAIJMatrix_8h.html">EpetraExt_PETScAIJMatrix.h</a></div></div>
<div class="ttc" id="aclassEpetra__LinearProblem_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__LinearProblem.html">Epetra_LinearProblem</a></div></div>
<div class="ttc" id="aclassEpetra__PETScAIJMatrix_html"><div class="ttname"><a href="classEpetra__PETScAIJMatrix.html">Epetra_PETScAIJMatrix</a></div><div class="ttdoc">Epetra_PETScAIJMatrix: A class for constructing and using real-valued sparse compressed row matrices.</div><div class="ttdef"><b>Definition</b> <a href="EpetraExt__PETScAIJMatrix_8h_source.html#l00087">EpetraExt_PETScAIJMatrix.h:87</a></div></div>
<div class="ttc" id="aclassEpetra__Vector_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__Vector.html">Epetra_Vector</a></div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 9 2025 20:37:18 for EpetraExt by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
