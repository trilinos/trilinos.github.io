<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ML: Example of use of ML_Epetra::MultiLevelOperator</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ML<span id="projectnumber">&#160;Version of the Day</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Example of use of ML_Epetra::MultiLevelOperator</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>We now report and comment and example of usage of <a class="el" href="classML__Epetra_1_1MultiLevelPreconditioner.html" title="MultiLevelPreconditioner: a class to define black-box multilevel preconditioners using aggregation me...">ML_Epetra::MultiLevelPreconditioner</a>. The source code can be found in ml_preconditioner.cpp.</p>
<p>Trilinos (and hence ML) requires the variable <code>HAVE_CONFIG_H</code> to be defined, either in the Makefile, or in the file itself. We suggest the following: </p><div class="fragment"><div class="line"><span class="preprocessor">#ifndef HAVE_CONFIG_H</span></div>
<div class="line"><span class="preprocessor">#define HAVE_CONFIG_H</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p>Then, we need to include several header files. Note that the example works for MPI and non-MPI configurations. However, some coarse solver requires MPI (like for instance <code>AMESOS-Superludist</code> and <code>AMESOS-Mumps</code>). <code>Trilinos_Util_CrsMatrixGallery.h</code> is required by this example, and not by ML.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;ml_include.h&quot;</span></div>
<div class="line"><span class="preprocessor">#ifdef HAVE_MPI</span></div>
<div class="line"><span class="preprocessor">#include &quot;mpi.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_MpiComm.h&quot;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_SerialComm.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_Map.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_IntVector.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_SerialDenseVector.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_Vector.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_CrsMatrix.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_VbrMatrix.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_LinearProblem.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_Time.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;AztecOO.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ml_epetra_preconditioner.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Trilinos_Util_CommandLineParser.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Trilinos_Util_CrsMatrixGallery.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ml__epetra__utils_8h.html">ml_epetra_utils.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ml_epetra_operator.h&quot;</span></div>
<div class="ttc" id="aml__epetra__utils_8h_html"><div class="ttname"><a href="ml__epetra__utils_8h.html">ml_epetra_utils.h</a></div><div class="ttdoc">Interface to the Trilinos package Anasazi.</div></div>
</div><!-- fragment --><p><code>HAVE_ML_TRIUTILS</code>, and the header files are required by the example, and not by the ML source. Class Trilinos_Util::CrsMatrixGallery is used to create an example matrix. This <a class="elRef" href="../../../epetra/doc/html/classEpetra__CrsMatrix.html">Epetra_CrsMatrix</a> is then converted to an ML_Operator (heavy-weight conversion).</p>
<dl class="section note"><dt>Note</dt><dd>ML accepts <a class="elRef" href="../../../epetra/doc/html/classEpetra__RowMatrix.html">Epetra_RowMatrix</a>'s; please refer to <a class="el" href="ml_preconditioner_cpp.html">ml_preconditioner.cpp</a>.</dd></dl>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceML__Epetra.html">ML_Epetra</a>;</div>
<div class="line"><span class="keyword">using namespace </span>Teuchos;</div>
<div class="line"><span class="keyword">using namespace </span>Trilinos_Util;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">#ifdef EPETRA_MPI</span></div>
<div class="line">  MPI_Init(&amp;argc,&amp;argv);</div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__MpiComm.html">Epetra_MpiComm</a> Comm(MPI_COMM_WORLD);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__SerialComm.html">Epetra_SerialComm</a> Comm;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  </div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__Time.html">Epetra_Time</a> Time(Comm);</div>
<div class="ttc" id="aclassEpetra__MpiComm_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__MpiComm.html">Epetra_MpiComm</a></div></div>
<div class="ttc" id="aclassEpetra__SerialComm_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__SerialComm.html">Epetra_SerialComm</a></div></div>
<div class="ttc" id="aclassEpetra__Time_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__Time.html">Epetra_Time</a></div></div>
<div class="ttc" id="anamespaceML__Epetra_html"><div class="ttname"><a href="namespaceML__Epetra.html">ML_Epetra</a></div><div class="ttdoc">ML_Epetra: default namespace for all Epetra interfaces.</div><div class="ttdef"><b>Definition</b> ml_epetra_utils.h:255</div></div>
</div><!-- fragment --><p> We parse the command line, to create the example matrix, get a pointer to this matrix. </p><div class="fragment"><div class="line">CommandLineParser CLP(argc,argv);</div>
<div class="line">CrsMatrixGallery Gallery(<span class="stringliteral">&quot;&quot;</span>, Comm);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// default values for problem type and size</span></div>
<div class="line"><span class="keywordflow">if</span>( CLP.Has(<span class="stringliteral">&quot;-problem_type&quot;</span>) == <span class="keyword">false</span> ) CLP.Add(<span class="stringliteral">&quot;-problem_type&quot;</span>, <span class="stringliteral">&quot;laplace_2d&quot;</span> ); </div>
<div class="line"><span class="keywordflow">if</span>( CLP.Has(<span class="stringliteral">&quot;-problem_size&quot;</span>) == <span class="keyword">false</span> ) CLP.Add(<span class="stringliteral">&quot;-problem_size&quot;</span>, <span class="stringliteral">&quot;100&quot;</span> ); </div>
<div class="line"> </div>
<div class="line"><span class="comment">// initialize MatrixGallery object with options specified in the shell</span></div>
<div class="line">Gallery.Set(CLP);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// get pointer to the linear system matrix</span></div>
<div class="line"><a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__CrsMatrix.html">Epetra_CrsMatrix</a> * A = Gallery.GetMatrix();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// get a pointer to the map</span></div>
<div class="line"><span class="keyword">const</span> <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__Map.html">Epetra_Map</a> * Map = Gallery.GetMap();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// get a pointer to the linear system problem</span></div>
<div class="line"><a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__LinearProblem.html">Epetra_LinearProblem</a> * Problem = Gallery.GetLinearProblem();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Construct a solver object for this problem</span></div>
<div class="line">AztecOO solver(*Problem);</div>
<div class="ttc" id="aclassEpetra__CrsMatrix_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__CrsMatrix.html">Epetra_CrsMatrix</a></div></div>
<div class="ttc" id="aclassEpetra__LinearProblem_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__LinearProblem.html">Epetra_LinearProblem</a></div></div>
<div class="ttc" id="aclassEpetra__Map_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__Map.html">Epetra_Map</a></div></div>
</div><!-- fragment --><p>This is the beginning of the ML part. We need to create an ML_handle, convert the input matrix into ML_Operator format, create an ML_Aggregate structure (that will hold the data about the aggregates).</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> nLevels = 10;</div>
<div class="line"><span class="keywordtype">int</span> maxMgLevels = 6;</div>
<div class="line">ML_Set_PrintLevel(10);</div>
<div class="line"><a class="code hl_struct" href="structML__Struct.html">ML</a> *ml_handle;</div>
<div class="line"> </div>
<div class="line">ML_Create(&amp;ml_handle, maxMgLevels);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// convert to epetra matrix, put finest matrix into</span></div>
<div class="line"><span class="comment">// position maxMgLevels - 1 of the hierarchy</span></div>
<div class="line"><a class="code hl_function" href="ml__epetra__utils_8h.html#a861059544ba9c54a94efd26f8a268dc1">EpetraMatrix2MLMatrix</a>(ml_handle, maxMgLevels-1, A);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// create an Aggregate object; this will contain information</span></div>
<div class="line"><span class="comment">// about the aggregation process for each level</span></div>
<div class="line"><a class="code hl_struct" href="structML__Aggregate__Struct.html">ML_Aggregate</a> *agg_object;</div>
<div class="line">ML_Aggregate_Create(&amp;agg_object);</div>
<div class="ttc" id="aml__epetra__utils_8h_html_a861059544ba9c54a94efd26f8a268dc1"><div class="ttname"><a href="ml__epetra__utils_8h.html#a861059544ba9c54a94efd26f8a268dc1">EpetraMatrix2MLMatrix</a></div><div class="ttdeci">int EpetraMatrix2MLMatrix(ML *ml_handle, int level, Epetra_RowMatrix *Amat)</div><div class="ttdoc">Wraps an Epetra_RowMatrix into an ML_Operators.</div></div>
<div class="ttc" id="astructML__Aggregate__Struct_html"><div class="ttname"><a href="structML__Aggregate__Struct.html">ML_Aggregate_Struct</a></div><div class="ttdef"><b>Definition</b> ml_aggregate.h:51</div></div>
<div class="ttc" id="astructML__Struct_html"><div class="ttname"><a href="structML__Struct.html">ML_Struct</a></div><div class="ttdef"><b>Definition</b> ml_struct.h:75</div></div>
</div><!-- fragment --><p> At this point we select out aggregation scheme (Uncoupled in this case), and we build the hierarchy. </p><div class="fragment"><div class="line">  ML_Aggregate_Set_CoarsenScheme_Uncoupled(agg_object);</div>
<div class="line">  nLevels = ML_Gen_MGHierarchy_UsingAggregation(ml_handle, maxMgLevels-1,</div>
<div class="line">                        ML_DECREASING, agg_object);</div>
<div class="line">\encode</div>
<div class="line"> </div>
<div class="line">Now, we define the ID of the coarsest level and set up the smoothers. We</div>
<div class="line">suppose to deal with a symmetric problem. We also set a simple coarse solver</div>
<div class="line">-- symmetric Gauss-Seidel.</div>
<div class="line"> </div>
<div class="line">\code</div>
<div class="line">  <span class="keywordtype">int</span> coarsestLevel = maxMgLevels - nLevels;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordtype">int</span> nits = 1;</div>
<div class="line">  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> level = maxMgLevels-1; level &gt; coarsestLevel; level--)</div>
<div class="line">    ML_Gen_Smoother_Cheby(ml_handle, level, ML_BOTH, 30., 3);</div>
<div class="line"> </div>
<div class="line">  ML_Gen_Smoother_SymGaussSeidel(ml_handle, coarsestLevel, ML_BOTH, </div>
<div class="line">                 nits, ML_DEFAULT);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// generate the solver</span></div>
<div class="line">  ML_Gen_Solver(ml_handle, ML_MGV, maxMgLevels-1, coarsestLevel);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// create an Epetra_Operator based on the previously created</span></div>
<div class="line">  <span class="comment">// hierarchy</span></div>
<div class="line">  <a class="code hl_class" href="classML__Epetra_1_1MultiLevelOperator.html">MultiLevelOperator</a> MLPrec(ml_handle, Comm, *Map, *Map);</div>
<div class="ttc" id="aclassML__Epetra_1_1MultiLevelOperator_html"><div class="ttname"><a href="classML__Epetra_1_1MultiLevelOperator.html">ML_Epetra::MultiLevelOperator</a></div><div class="ttdoc">MultiLevelOperator: An implementation of the Epetra_Operator class.</div><div class="ttdef"><b>Definition</b> ml_MultiLevelOperator.h:61</div></div>
</div><!-- fragment --><p>This is the end of the ML settings. We just need to instruct AztecOO about the existence of <code>MLPrec</code>.</p>
<div class="fragment"><div class="line">  solver.SetPrecOperator(&amp;MLPrec);</div>
<div class="line"> </div>
<div class="line">  solver.SetAztecOption(AZ_solver, AZ_cg_condnum);</div>
<div class="line">  solver.SetAztecOption(AZ_output, 16);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// solve with AztecOO</span></div>
<div class="line">  solver.Iterate(500, 1e-5);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef EPETRA_MPI</span></div>
<div class="line">  MPI_Finalize() ;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0 ;</div>
<div class="line">  </div>
<div class="line">}</div>
</div><!-- fragment --><p>To execute this example,/from the command line, you may try something like that: </p><div class="fragment"><div class="line">$ mpirun -np 4 ./ml_operator.exe -problem_type=laplace_3d </div>
<div class="line">          -problem_size=1000</div>
</div><!-- fragment --><p> For more options for Trilinos_Util::CrsMatrixGallery, consult the Trilinos 4.0 tutorial. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
