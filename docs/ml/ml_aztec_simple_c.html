<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ML: ml_aztec_simple.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ML<span id="projectnumber">&#160;Version of the Day</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">ml_aztec_simple.c</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><div class="line"><span class="comment">/* ******************************************************************** */</span></div>
<div class="line"><span class="comment">/* See the file COPYRIGHT for a complete copyright notice, contact      */</span></div>
<div class="line"><span class="comment">/* person and disclaimer.                                               */</span></div>
<div class="line"><span class="comment">/* ******************************************************************** */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/*****************************************************************************/</span></div>
<div class="line"><span class="comment">/* Sample driver for Poisson equation AMG smoothed aggregation solver in the */</span></div>
<div class="line"><span class="comment">/* ML package using Aztec. This test is on a square using a 2-dimensional    */</span></div>
<div class="line"><span class="comment">/* uniform grid with Dirichlet boundary conditions.                          */</span></div>
<div class="line"><span class="comment">/* Note: Dirichlet nodes are not stored in the matrix.                       */</span></div>
<div class="line"><span class="comment">/* The node numbering in this example is lexicographical. That is,           */</span></div>
<div class="line"><span class="comment">/*                                                                           */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*     ----------(12)----------(13)----------(14)----------(15)----------    */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*     ----------( 8)----------( 9)----------(10)----------(11)----------    */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*     ----------( 4)----------( 5)----------( 6)----------( 7)----------    */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*     ----------( 0)----------( 1)----------( 2)----------( 3)----------    */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                 |             |             |             |               */</span></div>
<div class="line"><span class="comment">/*                                                                           */</span></div>
<div class="line"><span class="comment">/*****************************************************************************/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;ml_include.h&quot;</span></div>
<div class="line"><span class="preprocessor">#if defined(HAVE_ML_AZTEC2_1) || defined(HAVE_ML_AZTECOO)</span></div>
<div class="line"><span class="preprocessor">#include &quot;az_aztec.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*****************************************************************************/</span></div>
<div class="line"><span class="comment">/* All functions/structures starting with the word &#39;user&#39; denote things that */</span></div>
<div class="line"><span class="comment">/* are not in ML and are specific to this particular example.                */</span></div>
<div class="line"><span class="comment">/*                                                                           */</span></div>
<div class="line"><span class="comment">/* User defined structure holding information on how the PDE is partitioned  */</span></div>
<div class="line"><span class="comment">/* over the processor system.                                                */</span></div>
<div class="line"><span class="comment">/*****************************************************************************/</span></div>
<div class="line"><span class="keyword">struct </span>user_partition_data {</div>
<div class="line">  <span class="keywordtype">int</span> *my_global_ids;      <span class="comment">/* my_global_ids[i]: id of ith local unknown.     */</span></div>
<div class="line">  <span class="keywordtype">int</span> *needed_external_ids;<span class="comment">/* global ids of ghost unknowns.                  */</span></div>
<div class="line">  <span class="keywordtype">int</span> Nlocal;              <span class="comment">/* Number of local unknowns.                      */</span></div>
<div class="line">  <span class="keywordtype">int</span> Nglobal;             <span class="comment">/* Number of global unknowns.                     */</span></div>
<div class="line">  <span class="keywordtype">int</span> *my_local_ids;       <span class="comment">/* my_local_ids[i]: local id of ith global unknown*/</span></div>
<div class="line">  <span class="keywordtype">int</span> mypid;               <span class="comment">/* processor id                                   */</span></div>
<div class="line">  <span class="keywordtype">int</span> nprocs;              <span class="comment">/* total number of processors.                    */</span></div>
<div class="line">  <span class="keywordtype">int</span> Nghost;              <span class="comment">/* number of ghost variables on processor.        */</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*****************************************************************************/</span></div>
<div class="line"><span class="comment">/* Function definitions.                                                     */</span></div>
<div class="line"><span class="comment">/*****************************************************************************/</span></div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span>        user_partition(<span class="keyword">struct</span> user_partition_data *Partition);</div>
<div class="line"><span class="keyword">extern</span> AZ_MATRIX   *user_Kn_build(<span class="keyword">struct</span> user_partition_data *);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef ML_MPI</span></div>
<div class="line"><span class="preprocessor">#define COMMUNICATOR   MPI_COMM_WORLD</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#define COMMUNICATOR   AZ_NOT_MPI</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>    Nnodes=128*128;              <span class="comment">/* Total number of nodes in the problem.*/</span></div>
<div class="line">                                    <span class="comment">/* &#39;Nnodes&#39; must be a perfect square.   */</span></div>
<div class="line">  <span class="keywordtype">int</span>    MaxMgLevels=6;             <span class="comment">/* Maximum number of Multigrid Levels   */</span></div>
<div class="line">  <span class="keywordtype">double</span> tolerance = 1.0e-8;        <span class="comment">/* At convergence:                      */</span></div>
<div class="line">                                    <span class="comment">/*   ||r_k||_2 &lt; tolerance ||r_0||_2    */</span></div>
<div class="line"> </div>
<div class="line">  <a class="code hl_struct" href="structML__Struct.html">ML</a>           *ml;</div>
<div class="line">  <a class="code hl_struct" href="structML__Aggregate__Struct.html">ML_Aggregate</a> *ag;</div>
<div class="line">  <span class="keywordtype">int</span>          Nlevels;</div>
<div class="line">  <span class="keywordtype">int</span>          level, coarsest_level;</div>
<div class="line">  <span class="keywordtype">double</span>       *rhs, *xxx;</div>
<div class="line">  <span class="keyword">struct       </span>user_partition_data Partition = {NULL, NULL,0,0,NULL,0,0,0};</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* See Aztec User&#39;s Guide for information on these variables */</span></div>
<div class="line"> </div>
<div class="line">  AZ_MATRIX    *Kn_mat;</div>
<div class="line">  AZ_PRECOND   *Pmat = NULL;</div>
<div class="line">  <span class="keywordtype">int</span>          proc_config[AZ_PROC_SIZE], options[AZ_OPTIONS_SIZE];</div>
<div class="line">  <span class="keywordtype">double</span>       params[AZ_PARAMS_SIZE], status[AZ_STATUS_SIZE];</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* get processor information (id &amp; # of procs) and set ML&#39;s printlevel. */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef ML_MPI</span></div>
<div class="line">  MPI_Init(&amp;argc,&amp;argv);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  AZ_set_proc_config(proc_config, COMMUNICATOR);</div>
<div class="line"> </div>
<div class="line">  ML_Set_PrintLevel(10);   <span class="comment">/* set ML&#39;s output level: 0 gives least output */</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Set the # of global nodes and partition over the processors.         */</span></div>
<div class="line"> </div>
<div class="line">  Partition.Nglobal = Nnodes;</div>
<div class="line">  user_partition(&amp;Partition);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Create an empty multigrid hierarchy and set the &#39;MaxMGLevels-1&#39;th      */</span></div>
<div class="line">  <span class="comment">/* level discretization within this hierarchy to the ML matrix            */</span></div>
<div class="line">  <span class="comment">/* representing Kn (Poisson discretization).                              */</span></div>
<div class="line"> </div>
<div class="line">  ML_Create(&amp;ml, MaxMgLevels);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Build Kn as Aztec matrices. Use built-in function AZ_ML_Set_Amat()    */</span></div>
<div class="line">  <span class="comment">/* to convert to an ML matrix and put in hierarchy.                      */</span></div>
<div class="line"> </div>
<div class="line">  Kn_mat = user_Kn_build( &amp;Partition);</div>
<div class="line">  AZ_ML_Set_Amat(ml, MaxMgLevels-1, Partition.Nlocal,</div>
<div class="line">         Partition.Nlocal, Kn_mat, proc_config);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">  /********************************************************************/</span></div>
<div class="line">  <span class="comment">/* Set some ML parameters.                                          */</span></div>
<div class="line">  <span class="comment">/*------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line">  ML_Aggregate_Create( &amp;ag );</div>
<div class="line">  ML_Aggregate_Set_CoarsenScheme_Uncoupled(ag);</div>
<div class="line">  ML_Aggregate_Set_MaxCoarseSize(ag, 30);</div>
<div class="line">  ML_Aggregate_Set_Threshold(ag, 0.0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /********************************************************************/</span></div>
<div class="line">  <span class="comment">/* Build hierarchy using smoothed aggregation.                      */</span></div>
<div class="line">  <span class="comment">/*------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line">  Nlevels = ML_Gen_MultiLevelHierarchy_UsingAggregation(ml, MaxMgLevels-1,</div>
<div class="line">                        ML_DECREASING, ag);</div>
<div class="line">  coarsest_level = MaxMgLevels - Nlevels;</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /***************************************************************</span></div>
<div class="line"><span class="comment">  * Set up smoothers for all levels. See paper &#39;Parallel</span></div>
<div class="line"><span class="comment">  * Multigrid Smoothing: Polynomial Versus Gauss-Seidel&#39; by Adams,</span></div>
<div class="line"><span class="comment">  * Brezina, Hu, Tuminaro in JCP&#39;03 for more details.</span></div>
<div class="line"><span class="comment">  ****************************************************************/</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">  /***************************************************************************/</span></div>
<div class="line">  <span class="comment">/*      ML_Gen_Smoother_Cheby: this corresponds to polynomial relaxation.  */</span></div>
<div class="line">  <span class="comment">/*      The degree of the polynomial is the last argument.                 */</span></div>
<div class="line">  <span class="comment">/*      If the degree is &#39;-1&#39;, Marian Brezina&#39;s MLS polynomial is chosen.  */</span></div>
<div class="line">  <span class="comment">/*      Otherwise, a Chebyshev polynomial is used over high frequencies    */</span></div>
<div class="line">  <span class="comment">/*      [ lambda_max/alpha , lambda_max]. Lambda_max is computed by taking */</span></div>
<div class="line">  <span class="comment">/*      a couple of steps of CG (and then boosting it a little). &#39;alpha&#39;   */</span></div>
<div class="line">  <span class="comment">/*      is hardwired in this example to be &#39;30&#39;. Normally, it should be    */</span></div>
<div class="line">  <span class="comment">/*      the ratio of unknowns in the fine and coarse meshes.               */</span></div>
<div class="line">  <span class="comment">/*                                                                         */</span></div>
<div class="line"><span class="comment">  /***************************************************************************/</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (level = MaxMgLevels-1; level &gt; coarsest_level; level--)</div>
<div class="line">    ML_Gen_Smoother_Cheby(ml, level, ML_BOTH, 30., 3);</div>
<div class="line"> </div>
<div class="line">  ML_Gen_Smoother_Amesos(ml, coarsest_level, ML_AMESOS_KLU, 1, 0.0, 1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Must be called before invoking the preconditioner */</span></div>
<div class="line">  ML_Gen_Solver(ml, ML_MGV, MaxMgLevels-1, coarsest_level);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Set initial guess and right hand side. */</span></div>
<div class="line"> </div>
<div class="line">  xxx = (<span class="keywordtype">double</span> *) ML_allocate((Partition.Nlocal+</div>
<div class="line">                Partition.Nghost)*<span class="keyword">sizeof</span>(double));</div>
<div class="line">  rhs = (<span class="keywordtype">double</span> *) ML_allocate(Partition.Nlocal*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line">  ML_random_vec(xxx, Partition.Nlocal, ml-&gt;<a class="code hl_variable" href="structML__Struct.html#ae0f8f1ecdd98112ff6bc300b21f3a96d">comm</a>);</div>
<div class="line">  ML_random_vec(rhs, Partition.Nlocal, ml-&gt;<a class="code hl_variable" href="structML__Struct.html#ae0f8f1ecdd98112ff6bc300b21f3a96d">comm</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Invoke solver */</span></div>
<div class="line"> </div>
<div class="line">  AZ_defaults(options, params);</div>
<div class="line">  options[AZ_solver]   = AZ_cg;</div>
<div class="line">  params[AZ_tol]       = tolerance;</div>
<div class="line">  options[AZ_conv]     = AZ_noscaled;</div>
<div class="line">  AZ_set_ML_preconditioner(&amp;Pmat, Kn_mat, ml, options);</div>
<div class="line">  AZ_iterate(xxx, rhs, options, params, status, proc_config, Kn_mat, Pmat, NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* clean up. */</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (Partition.my_local_ids != NULL) free(Partition.my_local_ids);</div>
<div class="line">  <span class="keywordflow">if</span> (Partition.my_global_ids != NULL) free(Partition.my_global_ids);</div>
<div class="line">  <span class="keywordflow">if</span> (Partition.needed_external_ids != NULL)</div>
<div class="line">    free(Partition.needed_external_ids);</div>
<div class="line"> </div>
<div class="line">  ML_Aggregate_Destroy(&amp;ag);</div>
<div class="line">  ML_Destroy(&amp;ml);</div>
<div class="line">  <span class="keywordflow">if</span> (Pmat  != NULL) AZ_precond_destroy(&amp;Pmat);</div>
<div class="line">  <span class="keywordflow">if</span> (Kn_mat != NULL) {</div>
<div class="line">    AZ_free(Kn_mat-&gt;bindx);</div>
<div class="line">    AZ_free(Kn_mat-&gt;val);</div>
<div class="line">    AZ_free(Kn_mat-&gt;data_org);</div>
<div class="line">    AZ_matrix_destroy(&amp;Kn_mat);</div>
<div class="line">  }</div>
<div class="line">  ML_free(xxx);</div>
<div class="line">  ML_free(rhs);</div>
<div class="line"><span class="preprocessor">#ifdef ML_MPI</span></div>
<div class="line">  MPI_Finalize();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Assign unknowns to processors */</span></div>
<div class="line"><span class="keywordtype">void</span> user_partition(<span class="keyword">struct</span> user_partition_data *Partition)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>    proc_config[AZ_PROC_SIZE];</div>
<div class="line"> </div>
<div class="line">  AZ_set_proc_config(proc_config, COMMUNICATOR);</div>
<div class="line"> </div>
<div class="line">  AZ_input_update(NULL,&amp;(Partition-&gt;Nlocal), &amp;(Partition-&gt;my_global_ids),</div>
<div class="line">          proc_config, Partition-&gt;Nglobal, 1, AZ_linear);</div>
<div class="line">  Partition-&gt;Nghost = 0;   <span class="comment">/* will be computed later */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/********************************************************************/</span></div>
<div class="line"><span class="comment">/* Set up Kn_mat                                                    */</span></div>
<div class="line"><span class="comment">/*  1) First set it up as an Aztec DMSR matrix                      */</span></div>
<div class="line"><span class="comment">/*     This stores the diagonal of row j in Ke_val[j] and stores a  */</span></div>
<div class="line"><span class="comment">/*     pointer to row j&#39;s off-diagonal nonzeros in Ke_bindx[j] with */</span></div>
<div class="line"><span class="comment">/*     column/nonzero entries in Ke_bindx[Ke_bindx[j]:Ke_bindx[j+1]-1] */</span></div>
<div class="line"><span class="comment">/*     and Ke_val[Ke_bindx[j]:Ke_bindx[j+1]-1].                     */</span></div>
<div class="line"><span class="comment">/*  2) call AZ_transform to convert global column indices to local  */</span></div>
<div class="line"><span class="comment">/*     indices and to set up Aztec&#39;s communication structure.       */</span></div>
<div class="line"><span class="comment">/*  3) Stuff the arrays into an Aztec matrix.                       */</span></div>
<div class="line"><span class="comment">/*------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line">AZ_MATRIX *user_Kn_build(<span class="keyword">struct</span> user_partition_data *Partition)</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> *Kn_bindx;</div>
<div class="line">  <span class="keywordtype">double</span> *Kn_val;</div>
<div class="line">  <span class="keywordtype">int</span>    proc_config[AZ_PROC_SIZE];</div>
<div class="line">  AZ_MATRIX *Kn_mat;</div>
<div class="line">  <span class="keywordtype">int</span>    *reordered_glob = NULL, *cpntr = NULL, *Kn_data_org = NULL;</div>
<div class="line">  <span class="keywordtype">int</span> i, ii, jj, nx, gid, Nlocal, nz_ptr;</div>
<div class="line">  <span class="keywordtype">int</span> *reordered_externs = NULL;  <span class="comment">/* Aztec thing */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  Nlocal = Partition-&gt;Nlocal;</div>
<div class="line">  Kn_bindx = (<span class="keywordtype">int</span>    *) malloc((27*Nlocal+5)*<span class="keyword">sizeof</span>(int));</div>
<div class="line">  Kn_val   = (<span class="keywordtype">double</span> *) malloc((27*Nlocal+5)*<span class="keyword">sizeof</span>(double));</div>
<div class="line">  Kn_bindx[0] = Nlocal+1;</div>
<div class="line"> </div>
<div class="line">  nx = (int) sqrt( ((<span class="keywordtype">double</span>) Partition-&gt;Nglobal) + .00001);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; Nlocal; i++) {</div>
<div class="line">    gid = (Partition-&gt;my_global_ids)[i];</div>
<div class="line"> </div>
<div class="line">    nz_ptr = Kn_bindx[i];</div>
<div class="line">    ii = gid%nx;</div>
<div class="line">    jj = (gid - ii)/nx;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ii != nx-1) { Kn_bindx[nz_ptr] = gid+ 1; Kn_val[nz_ptr++] = -1.;}</div>
<div class="line">    <span class="keywordflow">if</span> (jj != nx-1) { Kn_bindx[nz_ptr] = gid+nx; Kn_val[nz_ptr++] = -1.;}</div>
<div class="line">    <span class="keywordflow">if</span> (jj !=    0) { Kn_bindx[nz_ptr] = gid-nx; Kn_val[nz_ptr++] = -1.;}</div>
<div class="line">    <span class="keywordflow">if</span> (ii !=    0) { Kn_bindx[nz_ptr] = gid- 1; Kn_val[nz_ptr++] = -1.;}</div>
<div class="line"> </div>
<div class="line">    Kn_val[i] = 4.;</div>
<div class="line">    Kn_bindx[i+1] = nz_ptr;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Transform the global Aztec matrix into a local Aztec matrix. That is,   */</span></div>
<div class="line">  <span class="comment">/* replace global column indices by local indices and set up communication */</span></div>
<div class="line">  <span class="comment">/* data structure &#39;Ke_data_org&#39; that will be used for matvec&#39;s.            */</span></div>
<div class="line"> </div>
<div class="line">  AZ_set_proc_config(proc_config, COMMUNICATOR);</div>
<div class="line"> </div>
<div class="line">  AZ_transform(proc_config,&amp;(Partition-&gt;needed_external_ids),</div>
<div class="line">                   Kn_bindx, Kn_val, Partition-&gt;my_global_ids,</div>
<div class="line">                   &amp;reordered_glob, &amp;reordered_externs,</div>
<div class="line">                   &amp;Kn_data_org, Nlocal, 0, 0, 0,</div>
<div class="line">                   &amp;cpntr, AZ_MSR_MATRIX);</div>
<div class="line">  Partition-&gt;Nghost = Kn_data_org[AZ_N_external];</div>
<div class="line">  AZ_free(reordered_glob);</div>
<div class="line">  AZ_free(reordered_externs);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Convert old style Aztec matrix to newer style Aztec matrix */</span></div>
<div class="line"> </div>
<div class="line">  Kn_mat = AZ_matrix_create( Nlocal );</div>
<div class="line">  AZ_set_MSR(Kn_mat, Kn_bindx, Kn_val, Kn_data_org, 0, NULL, AZ_LOCAL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span>(Kn_mat);</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef HAVE_MPI</span></div>
<div class="line"><span class="preprocessor">#include &quot;mpi.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#ifdef ML_MPI</span></div>
<div class="line">  MPI_Init(&amp;argc,&amp;argv);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  puts(<span class="stringliteral">&quot;Please configure ML with --enable-aztecoo to run this example&quot;</span>);</div>
<div class="line"><span class="preprocessor">#ifdef ML_MPI</span></div>
<div class="line">  MPI_Finalize();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  <span class="comment">/* returns ok not to break the test harness */</span></div>
<div class="line">  <span class="keywordflow">return</span>(EXIT_SUCCESS);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* HAVE_ML_AZTECOO || HAVE_ML_AZTEC2_1 */</span><span class="preprocessor"></span></div>
<div class="ttc" id="astructML__Aggregate__Struct_html"><div class="ttname"><a href="structML__Aggregate__Struct.html">ML_Aggregate_Struct</a></div><div class="ttdef"><b>Definition</b> ml_aggregate.h:51</div></div>
<div class="ttc" id="astructML__Struct_html"><div class="ttname"><a href="structML__Struct.html">ML_Struct</a></div><div class="ttdef"><b>Definition</b> ml_struct.h:75</div></div>
<div class="ttc" id="astructML__Struct_html_ae0f8f1ecdd98112ff6bc300b21f3a96d"><div class="ttname"><a href="structML__Struct.html#ae0f8f1ecdd98112ff6bc300b21f3a96d">ML_Struct::comm</a></div><div class="ttdeci">ML_Comm * comm</div><div class="ttdef"><b>Definition</b> ml_struct.h:118</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 9 2025 20:41:06 for ML by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
