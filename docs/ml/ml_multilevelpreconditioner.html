<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ML: Example of use ML_Epetra::MultiLevelPreconditioner</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ML<span id="projectnumber">&#160;Version of the Day</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Example of use ML_Epetra::MultiLevelPreconditioner</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>We now report and comment and example of usage of <a class="el" href="classML__Epetra_1_1MultiLevelPreconditioner.html" title="MultiLevelPreconditioner: a class to define black-box multilevel preconditioners using aggregation me...">ML_Epetra::MultiLevelPreconditioner</a>. The source code can be found in ml_preconditioner.cpp.</p>
<p>First, we need to include several header files. Note that the example works for MPI and non-MPI configurations. However, some coarse solver requires MPI (like for instance <code>AMESOS-Superludist</code> and <code>AMESOS-Mumps</code>). <code>Trilinos_Util_CrsMatrixGallery.h</code> is required by this example, and not by ML.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef HAVE_MPI</span></div>
<div class="line"><span class="preprocessor">#include &quot;mpi.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_MpiComm.h&quot;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_SerialComm.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_Map.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_SerialDenseVector.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_Vector.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_CrsMatrix.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Epetra_LinearProblem.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;AztecOO.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Trilinos_Util_CrsMatrixGallery.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ml_include.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ml_epetra_preconditioner.h&quot;</span></div>
</div><!-- fragment --><p>The following namespace will be used quite often: </p><div class="fragment"><div class="line"><span class="keyword">using namespace </span>Teuchos;</div>
<div class="line"><span class="keyword">using namespace </span>Trilinos_Util;</div>
</div><!-- fragment --><p>We can now start with the <code>main()</code> function. We create the linear problem using the class <code>Trilinos_Util::CrsMatrixGallery</code>. Several matrix examples are supported; please refer to the Trilinos tutorial for more details. Most of the examples using the <code><a class="el" href="classML__Epetra_1_1MultiLevelPreconditioner.html" title="MultiLevelPreconditioner: a class to define black-box multilevel preconditioners using aggregation me...">ML_Epetra::MultiLevelPreconditioner</a></code> class are based on <a class="elRef" href="../../../epetra/doc/html/classEpetra__CrsMatrix.html">Epetra_CrsMatrix</a>. Example <code>ml_EpetraVbr.cpp</code> shows how to define a <a class="elRef" href="../../../epetra/doc/html/classEpetra__VbrMatrix.html">Epetra_VbrMatrix</a>.</p>
<p><code>laplace_2d</code> is a symmetric matrix; an example of non-symmetric matrices is <code>recirc_2d'</code> (advection-diffusion in a box, with recirculating flow). The number of nodes must be a square number</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef EPETRA_MPI</span></div>
<div class="line">  MPI_Init(&amp;argc,&amp;argv);</div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__MpiComm.html">Epetra_MpiComm</a> Comm(MPI_COMM_WORLD);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  <a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__SerialComm.html">Epetra_SerialComm</a> Comm;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  CrsMatrixGallery Gallery(<span class="stringliteral">&quot;laplace_2d&quot;</span>, Comm);</div>
<div class="line">  <span class="keywordtype">int</span> nx = 128;;</div>
<div class="line">  Gallery.Set(<span class="stringliteral">&quot;problem_size&quot;</span>, nx*nx);</div>
<div class="ttc" id="aclassEpetra__MpiComm_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__MpiComm.html">Epetra_MpiComm</a></div></div>
<div class="ttc" id="aclassEpetra__SerialComm_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__SerialComm.html">Epetra_SerialComm</a></div></div>
</div><!-- fragment --><p>The following methods of CrsMatrixGallery are used to get pointers to internally stored <a class="elRef" href="../../../epetra/doc/html/classEpetra__RowMatrix.html">Epetra_RowMatrix</a> and <a class="elRef" href="../../../epetra/doc/html/classEpetra__LinearProblem.html">Epetra_LinearProblem</a>. Then, as we wish to use AztecOO, we need to construct a solver object for this problem.</p>
<div class="fragment"><div class="line"><a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__RowMatrix.html">Epetra_RowMatrix</a> * A = Gallery.GetMatrix();</div>
<div class="line"><a class="code hl_classRef" href="../../../epetra/doc/html/classEpetra__LinearProblem.html">Epetra_LinearProblem</a> * Problem = Gallery.GetLinearProblem();</div>
<div class="line">AztecOO solver(*Problem);</div>
<div class="ttc" id="aclassEpetra__LinearProblem_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__LinearProblem.html">Epetra_LinearProblem</a></div></div>
<div class="ttc" id="aclassEpetra__RowMatrix_html"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__RowMatrix.html">Epetra_RowMatrix</a></div></div>
</div><!-- fragment --><p>This is the beginning of the ML part. We proceed as follows:</p><ul>
<li>we create a parameter list for ML options;</li>
<li>set default values for classical smoothed aggregation;</li>
<li>overwrite some parameters. Please refer to the user's guide for more information some of the parameters do not differ from their default value, Here the smoother is symmetric Gauss-Seidel. Example file ml_2level_DD.cpp shows how to use AZTEC's preconditioners as smoothers and they are here reported for the sake of clarity maximum number of levels. We solve the coarse problem with serial direct solver KLU.</li>
</ul>
<div class="fragment"><div class="line">ParameterList MLList;</div>
<div class="line"><a class="code hl_function" href="namespaceML__Epetra.html#a56d4ce3baee9b349ed2333326e0ec2b6">ML_Epetra::SetDefaults</a>(<span class="stringliteral">&quot;SA&quot;</span>,MLList);</div>
<div class="line">MLList.set(<span class="stringliteral">&quot;max levels&quot;</span>,6);</div>
<div class="line">MLList.set(<span class="stringliteral">&quot;increasing or decreasing&quot;</span>,<span class="stringliteral">&quot;decreasing&quot;</span>);</div>
<div class="line">MLList.set(<span class="stringliteral">&quot;aggregation: type&quot;</span>, <span class="stringliteral">&quot;Uncoupled&quot;</span>);</div>
<div class="line">MLList.set(<span class="stringliteral">&quot;aggregation: threshold&quot;</span>, 0.0);</div>
<div class="line"> </div>
<div class="line">MLList.set(<span class="stringliteral">&quot;smoother: type&quot;</span>,<span class="stringliteral">&quot;Gauss-Seidel&quot;</span>);</div>
<div class="line">MLList.set(<span class="stringliteral">&quot;smoother: pre or post&quot;</span>, <span class="stringliteral">&quot;both&quot;</span>);</div>
<div class="line"> </div>
<div class="line">MLList.set(<span class="stringliteral">&quot;coarse: type&quot;</span>,<span class="stringliteral">&quot;Amesos_KLU&quot;</span>);</div>
<div class="line">MLList.set(<span class="stringliteral">&quot;coarse: maximum size&quot;</span>,30);</div>
<div class="ttc" id="anamespaceML__Epetra_html_a56d4ce3baee9b349ed2333326e0ec2b6"><div class="ttname"><a href="namespaceML__Epetra.html#a56d4ce3baee9b349ed2333326e0ec2b6">ML_Epetra::SetDefaults</a></div><div class="ttdeci">int SetDefaults(std::string ProblemType, Teuchos::ParameterList &amp;List, int *options=0, double *params=0, const bool OverWrite=true)</div><div class="ttdoc">Sets default parameters for aggregation-based preconditioners.</div></div>
</div><!-- fragment --><p>Now, we create the preconditioning object. We suggest to use &lsquo;new&rsquo; and &lsquo;delete&rsquo; because the destructor contains some calls to MPI (as required by ML and possibly Amesos). This is an issue only if the destructor is called <b>after</b> MPI_Finalize(). Then, we instruct AztecOO to use this preconditioner and solve with 500 iterations and 1e-12 tolerance.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classML__Epetra_1_1MultiLevelPreconditioner.html">ML_Epetra::MultiLevelPreconditioner</a> * MLPrec = <span class="keyword">new</span></div>
<div class="line">   <a class="code hl_class" href="classML__Epetra_1_1MultiLevelPreconditioner.html">ML_Epetra::MultiLevelPreconditioner</a>(A, MLList, <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">solver.SetPrecOperator(MLPrec);</div>
<div class="line"> </div>
<div class="line">Problem-&gt;<a class="code hl_functionRef" href="../../../epetra/doc/html/classEpetra__LinearProblem.html#ae53cc20a6630ec9d9aeafbbcce294cbc">GetLHS</a>()-&gt;<a class="code hl_functionRef" href="../../../epetra/doc/html/classEpetra__MultiVector.html#ad6f671d0d84d754bd103afc8dbfd5e01">PutScalar</a>(0.0);</div>
<div class="line">Problem-&gt;<a class="code hl_functionRef" href="../../../epetra/doc/html/classEpetra__LinearProblem.html#a13545b09a9ed6052940ad9b93f1f3311">GetRHS</a>()-&gt;<a class="code hl_functionRef" href="../../../epetra/doc/html/classEpetra__MultiVector.html#ad6f671d0d84d754bd103afc8dbfd5e01">PutScalar</a>(1.0);</div>
<div class="line"> </div>
<div class="line">solver.SetAztecOption(AZ_solver, AZ_cg);</div>
<div class="line">solver.SetAztecOption(AZ_conv, AZ_noscaled);</div>
<div class="line">solver.SetAztecOption(AZ_output, 1);</div>
<div class="line"> </div>
<div class="line">solver.Iterate(500, 1e-8);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">delete</span> MLPrec;</div>
<div class="ttc" id="aclassEpetra__LinearProblem_html_a13545b09a9ed6052940ad9b93f1f3311"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__LinearProblem.html#a13545b09a9ed6052940ad9b93f1f3311">Epetra_LinearProblem::GetRHS</a></div><div class="ttdeci">Epetra_MultiVector * GetRHS() const</div></div>
<div class="ttc" id="aclassEpetra__LinearProblem_html_ae53cc20a6630ec9d9aeafbbcce294cbc"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__LinearProblem.html#ae53cc20a6630ec9d9aeafbbcce294cbc">Epetra_LinearProblem::GetLHS</a></div><div class="ttdeci">Epetra_MultiVector * GetLHS() const</div></div>
<div class="ttc" id="aclassEpetra__MultiVector_html_ad6f671d0d84d754bd103afc8dbfd5e01"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__MultiVector.html#ad6f671d0d84d754bd103afc8dbfd5e01">Epetra_MultiVector::PutScalar</a></div><div class="ttdeci">int PutScalar(double ScalarConstant)</div></div>
<div class="ttc" id="aclassML__Epetra_1_1MultiLevelPreconditioner_html"><div class="ttname"><a href="classML__Epetra_1_1MultiLevelPreconditioner.html">ML_Epetra::MultiLevelPreconditioner</a></div><div class="ttdoc">MultiLevelPreconditioner: a class to define black-box multilevel preconditioners using aggregation me...</div><div class="ttdef"><b>Definition</b> ml_MultiLevelPreconditioner.h:247</div></div>
</div><!-- fragment --><p>At this point, we can compute the true residual, and quit. </p><div class="fragment"><div class="line">  <span class="keywordtype">double</span> residual, diff;</div>
<div class="line">  Gallery.ComputeResidual(residual);</div>
<div class="line">  Gallery.ComputeDiffBetweenStartingAndExactSolutions(diff);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>( Comm.<a class="code hl_functionRef" href="../../../epetra/doc/html/classEpetra__SerialComm.html#a237a6407573dea22f0366936d158486d">MyPID</a>()==0) {</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;||b-Ax||_2 = &quot;</span> &lt;&lt; residual &lt;&lt; endl;</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;||x_exact - x||_2 = &quot;</span> &lt;&lt; diff &lt;&lt; endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef</span></div>
<div class="line">  EPETRA_MPI MPI_Finalize() ;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0 ;</div>
<div class="line">}</div>
<div class="ttc" id="aclassEpetra__SerialComm_html_a237a6407573dea22f0366936d158486d"><div class="ttname"><a href="../../../epetra/doc/html/classEpetra__SerialComm.html#a237a6407573dea22f0366936d158486d">Epetra_SerialComm::MyPID</a></div><div class="ttdeci">int MyPID() const</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 9 2025 20:41:06 for ML by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
